# Gemini Auth Improvement Plan

**Generated by**: GPT-5 Codex (gpt-5-codex model)
**Date**: 2026-02-16
**Confidence**: 0.81

## Background

Ultimate Debate's Gemini authentication system works but has known issues:
- Issue #3: Google Cloud SDK Client ID doesn't support generative-language scope
- Issue #4: Windows Credential Manager token storage failure (keyring)

## Current State

| Component | Status |
|-----------|--------|
| GoogleProvider | Gemini CLI token reuse + Browser OAuth PKCE |
| GeminiClient | 3 endpoints (Code Assist/Vertex AI/Google AI) |
| Token Store | keyring-based, Windows issues |
| Tests | test_gemini_cli_token.py (203 lines) |

## GPT-5 Analysis

### Strengths
1. PKCE OAuth + Gemini CLI credential reuse for streamlined login
2. 3 API endpoints with clear refresh/validate/logout flow and 401/403 error handling

### Weaknesses
1. Windows Credential Manager keyring integration failure (Issue #4)
2. Limited platform flexibility (scope expansion, token storage diversity)

### Missing Features
1. Configurable fixed port option, diagnostic logging
2. Multi-account token management, env-based scope configuration

## Design Proposal: Gemini Auth Reliability & Security Enhancement

### Change 1: Platform-specific Token Backend (HIGH)
- **File**: `google_provider.py`
- **Details**: Replace keyring with direct pywin32 Credential Manager calls or JSON+DPAPI on Windows. Parameterize scopes via env var or CLI input to support generativelanguage scope.

### Change 2: Abstract Token Storage Module (HIGH)
- **File**: `auth/storage.py` (new module)
- **Details**: Create BaseTokenStorage interface with implementations for:
  - macOS: Keychain
  - Linux: Secret Service
  - Windows: DPAPI
  - Inject into GoogleProvider for testability

### Change 3: Error Handling & Port Configuration (MEDIUM)
- **File**: `gemini_client.py`
- **Details**:
  - Graceful fallback logging on token storage failure in ensure_authenticated()
  - Add GEMINI_AUTH_PORT env var for port configuration
  - Enhanced retry policy for non-401/403 HTTP errors

### Change 4: Security & Configuration Guide (LOW)
- **File**: `docs/auth.md`
- **Details**: Document Windows Credential workarounds, scope expansion, security best practices

## Security Recommendations
1. Use OS-level encryption APIs (DPAPI) for token storage
2. Whitelist redirect ports, strengthen CSRF state parameter validation
3. Enforce minimum privilege and clear expiration policies for refresh tokens

## Risk Assessment
- DPAPI is Windows-only; needs fallback for other platforms
- Changing token storage format requires migration path
- Scope changes may break existing Gemini CLI token compatibility

## Impact Files
- `src/ultimate_debate/auth/providers/google_provider.py`
- `src/ultimate_debate/clients/gemini_client.py`
- `src/ultimate_debate/auth/storage/token_store.py`
- `tests/test_auth/test_gemini_cli_token.py`
